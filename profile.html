/**
 * ==========================================
 * TRIBERIUM â€” Profile Module
 * ------------------------------------------
 * Handles user profile display, DM, editing,
 * and profile post actions.
 * ==========================================
 */

import { db, auth, monitorAuthState, getDocument, listenCollection, updateDocument } from "./firebaseModule.js";

/**
 * =========================
 * DOM References
 * =========================
 */
const profileNameEl = document.getElementById("profileName");
const profileHandleEl = document.getElementById("profileHandle");
const profilePicEl = document.getElementById("profilePic");
const profileBioEl = document.getElementById("profileBio");
const profileStatsEl = document.getElementById("profileStats");
const postsContainer = document.getElementById("profilePosts");
const dmBtn = document.getElementById("dmUser");
const editProfileBtn = document.getElementById("editProfile");

/**
 * =========================
 * Helper Functions
 * =========================
 */

/**
 * Renders user's profile data
 * @param {Object} userData 
 */
const renderProfile = (userData) => {
  profileNameEl.textContent = userData.username || "Unknown";
  profileHandleEl.textContent = `@${userData.handle || "unknown"}`;
  profilePicEl.src = userData.profilePic || ""; // blank if empty
  profileBioEl.textContent = userData.bio || "No bio yet.";
  profileStatsEl.innerHTML = `
    <span>Posts: ${userData.postsCount || 0}</span>
    <span>Followers: ${userData.followersCount || 0}</span>
    <span>Following: ${userData.followingCount || 0}</span>
  `;
};

/**
 * Creates a single post for profile feed
 * @param {Object} postData 
 * @returns {HTMLElement}
 */
const createProfilePost = (postData) => {
  const postEl = document.createElement("div");
  postEl.classList.add("post");
  postEl.id = postData.id;

  const headerEl = document.createElement("div");
  headerEl.classList.add("post-header");

  // User info (just handle, since profile owner)
  const userInfoEl = document.createElement("div");
  userInfoEl.classList.add("user-info");

  const profileImg = document.createElement("img");
  profileImg.src = postData.profilePic || "";
  profileImg.alt = postData.username;

  const nameContainer = document.createElement("div");
  nameContainer.style.display = "flex";
  nameContainer.style.flexDirection = "column";

  const usernameEl = document.createElement("div");
  usernameEl.classList.add("username");
  usernameEl.textContent = postData.username;

  const handleEl = document.createElement("div");
  handleEl.classList.add("handle");
  handleEl.textContent = `@${postData.handle}`;

  nameContainer.appendChild(usernameEl);
  nameContainer.appendChild(handleEl);
  userInfoEl.appendChild(profileImg);
  userInfoEl.appendChild(nameContainer);

  headerEl.appendChild(userInfoEl);

  // DM button in profile
  const dmButton = document.createElement("button");
  dmButton.textContent = "DM";
  dmButton.onclick = () => openDM(postData.handle);
  headerEl.appendChild(dmButton);

  // Post Content
  const contentEl = document.createElement("div");
  contentEl.classList.add("post-content");
  contentEl.textContent = postData.content;

  // Post Actions
  const actionsEl = document.createElement("div");
  actionsEl.classList.add("post-actions");

  const likeBtn = document.createElement("span");
  likeBtn.textContent = "like";
  likeBtn.onclick = () => likePost(postData.id);

  const retribeBtn = document.createElement("span");
  retribeBtn.textContent = "retribe";
  retribeBtn.onclick = () => retribePost(postData.id);

  const saveBtn = document.createElement("span");
  saveBtn.textContent = "save";
  saveBtn.onclick = () => savePost(postData.id);

  actionsEl.appendChild(likeBtn);
  actionsEl.appendChild(retribeBtn);
  actionsEl.appendChild(saveBtn);

  postEl.appendChild(headerEl);
  postEl.appendChild(contentEl);
  postEl.appendChild(actionsEl);

  return postEl;
};

/**
 * =========================
 * Profile Actions
 * =========================
 */
const likePost = (postId) => console.log(`Liked post: ${postId}`);
const retribePost = (postId) => console.log(`Retribed post: ${postId}`);
const savePost = (postId) => console.log(`Saved post: ${postId}`);
const openDM = (handle) => console.log(`Open DM with: ${handle}`);

const editProfile = () => {
  const newBio = prompt("Update your bio:");
  if (newBio !== null) {
    updateDocument("users", auth.currentUser.uid, { bio: newBio });
    profileBioEl.textContent = newBio;
  }
};

/**
 * =========================
 * Load Profile
 * =========================
 */
const loadProfile = async () => {
  const uid = auth.currentUser.uid;
  const userData = await getDocument("users", uid);
  renderProfile(userData);

  listenCollection("posts", (posts) => {
    postsContainer.innerHTML = "";
    posts
      .filter(p => p.uid === uid)
      .forEach(post => {
        postsContainer.appendChild(createProfilePost(post));
      });
  });
};

/**
 * =========================
 * Initialize Profile
 * =========================
 */
monitorAuthState(user => {
  if (user) {
    loadProfile();
    editProfileBtn.onclick = editProfile;
    dmBtn.onclick = () => console.log("DM Clicked"); // placeholder
  } else {
    window.location.href = "index.html";
  }
});
